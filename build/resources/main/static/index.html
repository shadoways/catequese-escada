<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Fichas - Catequese</title>
  <style>
    :root {
      color-scheme: light;
      --ink: #1b1a16;
      --muted: #5b5a52;
      --accent: #c05f3c;
      --accent-2: #2f6f7e;
      --paper: #f5efe7;
      --paper-2: #f9f4ee;
      --highlight: #f1c97a;
      --stroke: #d8cdbc;
      --shadow: 0 18px 55px rgba(33, 28, 20, 0.18);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Alegreya", "Palatino Linotype", "Book Antiqua", Palatino, serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 10% 10%, rgba(192, 95, 60, 0.12), transparent 45%),
        radial-gradient(circle at 90% 20%, rgba(47, 111, 126, 0.18), transparent 40%),
        linear-gradient(120deg, #fdf7f0 0%, #f3e7d7 100%);
      min-height: 100vh;
      padding: 32px 20px 60px;
    }

    .shell {
      max-width: 1150px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    header {
      display: grid;
      gap: 8px;
      padding: 24px 28px;
      background: var(--paper-2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      animation: float-in 700ms ease-out;
    }

    header::after {
      content: "";
      position: absolute;
      inset: -40% 35% auto auto;
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, rgba(241, 201, 122, 0.45), transparent 70%);
      pointer-events: none;
    }

    h1 {
      margin: 0;
      font-family: "Cormorant Garamond", "Goudy Old Style", Garamond, serif;
      font-weight: 600;
      font-size: clamp(2rem, 3vw, 2.8rem);
      letter-spacing: 0.02em;
    }

    .sub {
      margin: 0;
      color: var(--muted);
      max-width: 680px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 24px;
    }

    .panel {
      background: var(--paper);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px 24px;
      display: grid;
      gap: 16px;
      animation: rise 600ms ease-out;
    }

    .panel:nth-child(2) { animation-delay: 120ms; }
    .panel:nth-child(3) { animation-delay: 220ms; }
    .panel:nth-child(4) { animation-delay: 320ms; }

    h2 {
      margin: 0;
      font-family: "Cormorant Garamond", "Goudy Old Style", Garamond, serif;
      font-size: 1.5rem;
    }

    label {
      display: grid;
      gap: 6px;
      font-size: 0.95rem;
      color: var(--muted);
    }

    input, textarea, select, button {
      font: inherit;
    }

    input, textarea, select {
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
      color: var(--ink);
    }

    textarea { min-height: 90px; resize: vertical; }

    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .tag {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(47, 111, 126, 0.12);
      color: var(--accent-2);
      font-size: 0.82rem;
    }

    .status {
      padding: 10px 14px;
      border-radius: 12px;
      background: rgba(192, 95, 60, 0.12);
      color: var(--accent);
      font-size: 0.9rem;
    }

    .status.ok { background: rgba(47, 111, 126, 0.14); color: var(--accent-2); }
    .status.error { background: rgba(192, 95, 60, 0.2); color: #9f2c0b; }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease;
      box-shadow: 0 10px 22px rgba(192, 95, 60, 0.25);
    }

    button.secondary {
      background: #fff;
      color: var(--accent);
      border: 1px solid var(--accent);
      box-shadow: none;
    }

    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    .signature {
      border: 1px dashed var(--stroke);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      display: grid;
      gap: 10px;
    }

    canvas {
      width: 100%;
      height: 180px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: #fefbf7;
      touch-action: none;
    }

    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .summary {
      display: grid;
      gap: 8px;
      font-size: 0.95rem;
    }

    @keyframes float-in {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>Cadastro de fichas</h1>
      <p class="sub">
        Formulario rapido para criar uma ficha de inscricao, anexar documentos e incluir assinatura digital.
        Todas as etapas sao executadas contra a API deste servidor.
      </p>
    </header>

    <div class="layout">
      <section class="panel">
        <div class="row" style="justify-content: space-between;">
          <h2>Dados do catequisando</h2>
          <span class="tag">/api/catequisandos</span>
        </div>
        <div class="grid">
          <label>
            Nome
            <input id="nome" type="text" required />
          </label>
          <label>
            Telefone
            <input id="telefone" type="tel" />
          </label>
          <label>
            Email
            <input id="email" type="email" />
          </label>
          <label>
            Data de nascimento
            <input id="data-nascimento" type="date" />
          </label>
          <label>
            Nome do responsavel
            <input id="nome-responsavel" type="text" />
          </label>
          <label>
            Telefone do responsavel
            <input id="telefone-responsavel" type="tel" />
          </label>
          <label>
            Endereço
            <input id="endereco" type="text" />
          </label>
          <label>
            Turma
            <select id="turma-select">
              <option value="">Selecione uma turma</option>
            </select>
          </label>
          <label>
            Comunidade
            <select id="comunidade-select">
              <option value="">Selecione uma comunidade</option>
            </select>
          </label>
        </div>
        <div style="border-top: 1px solid var(--stroke); padding-top: 16px; margin-top: 12px;"></div>
        <div class="grid">
          <label style="grid-column: 1;">
            Número do documento
            <input id="numero-documento" type="text" />
          </label>
          <div style="grid-column: 2;">
            <label style="margin-bottom: 12px;">Tipo de documento</label>
            <div style="display: flex; gap: 20px;">
              <label class="row" style="margin: 0;">
                <input type="radio" name="tipo-documento" value="RG" />
                RG
              </label>
              <label class="row" style="margin: 0;">
                <input type="radio" name="tipo-documento" value="CPF" />
                CPF
              </label>
            </div>
          </div>
        </div>
        <div style="border-top: 1px solid var(--stroke); padding-top: 16px; margin-top: 12px;"></div>
        <label style="margin-bottom: 12px;">Intolerante a gluten?</label>
        <label class="row">
          <input id="intolerante" type="checkbox" />
          Sim
        </label>
        <div style="border-top: 1px solid var(--stroke); padding-top: 16px; margin-top: 12px;"></div>
        <label style="margin-bottom: 12px;">Quais sacramentos possui?</label>
        <label class="row">
          <input id="batizado" type="checkbox" />
          Já foi batizado?
        </label>
        <label class="row">
          <input id="primeira-eucaristia" type="checkbox" />
          Já fez primeira eucaristia?
        </label>
        <div style="border-top: 1px solid var(--stroke); padding-top: 16px; margin-top: 12px;">
          <label style="margin-bottom: 12px;">Estado de convivência conjugal</label>
          <div style="display: grid; gap: 10px;">
            <label class="row" style="margin: 0;">
              <input type="radio" name="estado-conjugal" value="CASADO_IGREJA" />
              Casado(a) na Igreja
            </label>
            <label class="row" style="margin: 0;">
              <input type="radio" name="estado-conjugal" value="CASADO_CIVIL" />
              Casado(a) apenas no civil
            </label>
            <label class="row" style="margin: 0;">
              <input type="radio" name="estado-conjugal" value="UNIAO_ESTAVEL" />
              União estável
            </label>
            <label class="row" style="margin: 0;">
              <input type="radio" name="estado-conjugal" value="VIVE_COMPANHEIRO" />
              Vive com companheiro(a)
            </label>
            <label class="row" style="margin: 0;">
              <input type="radio" name="estado-conjugal" value="SEGUNDA_UNIAO" />
              Segunda união
            </label>
            <label class="row" style="margin: 0;">
              <input type="radio" name="estado-conjugal" value="NAO_VIVE_UNIAO" />
              Não vive em união conjugal
            </label>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="row" style="justify-content: space-between;">
          <h2>Ficha de inscricao</h2>
          <span class="tag">/api/fichas</span>
        </div>
        <div class="grid">
          <label>
            Data de inscricao
            <input id="data-inscricao" type="date" />
          </label>
          <label>
            Observacoes
            <textarea id="observacoes" placeholder="Alguma observacao importante..."></textarea>
          </label>
        </div>
        <p class="muted">A ficha sera vinculada ao catequisando criado acima.</p>
      </section>

      <section class="panel">
        <div class="row" style="justify-content: space-between;">
          <h2>Anexos e assinatura</h2>
          <span class="tag">/api/files</span>
        </div>
        <label>
          Arquivos anexos
          <input id="anexos" type="file" multiple />
        </label>
        <div class="signature">
          <strong>Assinatura digital</strong>
          <canvas id="signature-pad" width="800" height="240"></canvas>
          <div class="row">
            <button id="btn-clear" class="secondary">Limpar assinatura</button>
            <span class="muted">Use mouse ou toque para assinar.</span>
          </div>
        </div>
        <p class="muted">Os anexos e a assinatura serao registrados como documentos vinculados ao catequisando.</p>
      </section>

      <section class="panel">
        <div class="row" style="justify-content: space-between;">
          <h2>Enviar cadastro</h2>
          <span class="tag">/api/documentos</span>
        </div>
        <button id="btn-submit">Cadastrar ficha</button>
        <div id="result" class="summary"></div>
      </section>
    </div>
  </div>

  <script>
    const result = document.getElementById("result");
    const turmasById = {};
    const comunidadesById = {};

    const setResult = (lines, type = "") => {
      result.innerHTML = "";
      if (!lines.length) return;
      const status = document.createElement("div");
      status.className = `status ${type}`.trim();
      status.textContent = lines[0];
      result.appendChild(status);
      lines.slice(1).forEach((line) => {
        const p = document.createElement("div");
        p.textContent = line;
        result.appendChild(p);
      });
    };

    const normalizeDate = (value) => value || null;

    const fetchJson = async (url, options = {}) => {
      const res = await fetch(url, options);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`${res.status} ${text || res.statusText}`);
      }
      if (res.status === 204) return null;
      return res.json();
    };


    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    ctx.lineWidth = 2.5;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#1b1a16";

    let drawing = false;
    let hasSignature = false;

    const getCanvasPos = (event) => {
      const rect = canvas.getBoundingClientRect();
      const clientX = event.touches ? event.touches[0].clientX : event.clientX;
      const clientY = event.touches ? event.touches[0].clientY : event.clientY;
      return {
        x: (clientX - rect.left) * (canvas.width / rect.width),
        y: (clientY - rect.top) * (canvas.height / rect.height)
      };
    };

    const startDraw = (event) => {
      drawing = true;
      hasSignature = true;
      const pos = getCanvasPos(event);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    };

    const draw = (event) => {
      if (!drawing) return;
      const pos = getCanvasPos(event);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    };

    const endDraw = () => {
      drawing = false;
      ctx.closePath();
    };

    canvas.addEventListener("pointerdown", startDraw);
    canvas.addEventListener("pointermove", draw);
    canvas.addEventListener("pointerup", endDraw);
    canvas.addEventListener("pointerleave", endDraw);

    document.getElementById("btn-clear").addEventListener("click", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasSignature = false;
    });

    const uploadFile = async (file) => {
      const form = new FormData();
      form.append("file", file);
      const res = await fetch("/api/files", {
        method: "POST",
        body: form
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`${res.status} ${text || res.statusText}`);
      }
      return res.json();
    };

    const createDocumento = async (payload) => fetchJson("/api/documentos", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const loadTurmas = async () => {
      const select = document.getElementById("turma-select");
      select.innerHTML = "<option value=\"\">Selecione uma turma</option>";
      const turmas = await fetchJson("/api/turmas");
      turmas.forEach((turma) => {
        turmasById[turma.idTurma] = turma;
        const option = document.createElement("option");
        option.value = turma.idTurma;
        option.textContent = `${turma.nome}${turma.ano ? " (" + turma.ano + ")" : ""}`;
        select.appendChild(option);
      });
    };

    const loadComunidades = async () => {
      const select = document.getElementById("comunidade-select");
      select.innerHTML = "<option value=\"\">Selecione uma comunidade</option>";
      const comunidades = await fetchJson("/api/comunidades");
      comunidades.forEach((comunidade) => {
        comunidadesById[comunidade.idComunidade] = comunidade;
        const option = document.createElement("option");
        option.value = comunidade.idComunidade;
        option.textContent = comunidade.nome;
        select.appendChild(option);
      });
    };

    document.getElementById("btn-submit").addEventListener("click", async () => {
      const nome = document.getElementById("nome").value.trim();
      if (!nome) {
        setResult(["Informe o nome do catequisando"], "error");
        return;
      }

      const catequisandoPayload = {
        nome,
        telefone: document.getElementById("telefone").value.trim() || null,
        email: document.getElementById("email").value.trim() || null,
        dataNascimento: normalizeDate(document.getElementById("data-nascimento").value),
        nomeResponsavel: document.getElementById("nome-responsavel").value.trim() || null,
        telefoneResponsavel: document.getElementById("telefone-responsavel").value.trim() || null,
        endereco: document.getElementById("endereco").value.trim() || null,
        numeroDocumento: document.getElementById("numero-documento").value.trim() || null,
        tipoDocumento: document.querySelector('input[name="tipo-documento"]:checked')?.value || null,
        intoleranteGluten: document.getElementById("intolerante").checked,
        foiBatizado: document.getElementById("batizado").checked,
        fezPrimeiraEucaristia: document.getElementById("primeira-eucaristia").checked,
        estadoConjugal: document.querySelector('input[name="estado-conjugal"]:checked')?.value || null,
        ativo: true
      };

      const fichaPayload = {
        dataInscricao: normalizeDate(document.getElementById("data-inscricao").value),
        observacoes: document.getElementById("observacoes").value.trim() || null
      };

      try {
        setResult(["Enviando cadastro..."]);

        const turmaId = document.getElementById("turma-select").value;
        if (turmaId) {
          const turma = turmasById[turmaId] || await fetchJson(`/api/turmas/${Number(turmaId)}`);
          catequisandoPayload.turma = turma;
        }

        const comunidadeId = document.getElementById("comunidade-select").value;
        if (comunidadeId) {
          const comunidade = comunidadesById[comunidadeId] || await fetchJson(`/api/comunidades/${Number(comunidadeId)}`);
          catequisandoPayload.comunidade = comunidade;
        }

        const catequisando = await fetchJson("/api/catequisandos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(catequisandoPayload)
        });

        // Enviar catequisandoId no payload da ficha (novo DTO)
        fichaPayload.catequisandoId = catequisando.idCatequisando;
        const ficha = await fetchJson("/api/fichas", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(fichaPayload)
        });

        const anexos = Array.from(document.getElementById("anexos").files || []);
        const today = new Date().toISOString().slice(0, 10);
        const docResults = [];

        for (const file of anexos) {
          const upload = await uploadFile(file);
          const doc = await createDocumento({
            tipoDocumento: "ANEXO",
            caminhoArquivo: upload.path || upload.filename,
            dataEnvio: today,
            catequisandoId: catequisando.idCatequisando
          });
          docResults.push(`Documento ${doc.idDocumento} salvo (${file.name})`);
        }

        if (hasSignature) {
          const dataUrl = canvas.toDataURL("image/png");
          const byteString = atob(dataUrl.split(",")[1]);
          const buffer = new Uint8Array(byteString.length);
          for (let i = 0; i < byteString.length; i += 1) {
            buffer[i] = byteString.charCodeAt(i);
          }
          const signatureFile = new File([buffer], `assinatura-${Date.now()}.png`, { type: "image/png" });
          const upload = await uploadFile(signatureFile);
          const doc = await createDocumento({
            tipoDocumento: "ASSINATURA",
            caminhoArquivo: upload.path || upload.filename,
            dataEnvio: today,
            catequisandoId: catequisando.idCatequisando
          });
          docResults.push(`Assinatura registrada (doc ${doc.idDocumento})`);
        }

        setResult([
          "Cadastro concluido",
          `Catequisando ID: ${catequisando.idCatequisando}`,
          `Ficha ID: ${ficha.idFicha}`,
          ...docResults
        ], "ok");
      } catch (err) {
        setResult([`Erro ao cadastrar: ${err.message}`], "error");
      }
    });

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await loadTurmas();
        await loadComunidades();
      } catch (err) {
        setResult([`Erro ao carregar dados: ${err.message}`], "error");
      }
    });

  </script>
</body>
</html>
